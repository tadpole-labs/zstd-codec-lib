name: Setup Build Dependencies

on:
  workflow_call:
    outputs:
      cache_key:
        value: ${{ jobs.setup.outputs.cache_key }}

env:
  # LLVM Configuration
  LLVM_VERSION: "21.1.5"
  LLVM_X64_URL: "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.5/LLVM-21.1.5-Linux-X64.tar.xz"
  LLVM_X64_FILE: "LLVM-21.1.5-Linux-X64.tar.xz"
  LLVM_X64_ATTESTATION: ".github/attestations/LLVM-21.1.5-Linux-X64.tar.xz.jsonl"
  LLVM_ARM64_URL: "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.5/LLVM-21.1.5-Linux-ARM64.tar.xz"
  LLVM_ARM64_FILE: "LLVM-21.1.5-Linux-ARM64.tar.xz"
  LLVM_ARM64_ATTESTATION: ".github/attestations/LLVM-21.1.5-Linux-ARM64.tar.xz.jsonl"
  
  # Binaryen Configuration
  BINARYEN_VERSION: "124"
  BINARYEN_X64_URL: "https://github.com/WebAssembly/binaryen/releases/download/version_124/binaryen-version_124-x86_64-linux.tar.gz"
  BINARYEN_X64_SHA256: "0290c3779fedf592b8da0ded3032ff55c41a2b7bfa2d6bf7b7bac6f0e6e28963"
  BINARYEN_ARM64_URL: "https://github.com/WebAssembly/binaryen/releases/download/version_124/binaryen-version_124-aarch64-linux.tar.gz"
  BINARYEN_ARM64_SHA256: "6291bd9a57d8e046f3bc099a4db386c147433a87f71c783a901c5b1792e38de3"
  
  # Zopfli Configuration
  ZOPFLI_COMMIT: "ccf9f0588d4a4509cb1040310ec122243e670ee6"
  ZOPFLI_REPO: "https://github.com/google/zopfli.git"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache_key: ${{ steps.keygen.outputs.key }}

    steps:
      - id: keygen
        shell: bash
        run: |
          echo "key=build-deps-llvm-${{ env.LLVM_VERSION }}-binaryen-${{ env.BINARYEN_VERSION }}-zopfli-${{ env.ZOPFLI_COMMIT }}-${{ runner.arch }}-${{ runner.os }}" >> $GITHUB_OUTPUT

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          submodules: recursive
          fetch-depth: 0

      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        id: cache-deps
        with:
          path: |
            ~/llvm-21
            ~/binaryen
            ~/zopfli
          key: ${{ steps.keygen.outputs.key }}
        
      - name: Setup build dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          ARCH=$(uname -m)

          # ---- LLVM ----
          if [ "$ARCH" = "x86_64" ]; then
            LLVM_URL="${{ env.LLVM_X64_URL }}"
            LLVM_FILE="${{ env.LLVM_X64_FILE }}"
            ATTESTATION_FILE="${{ env.LLVM_X64_ATTESTATION }}"
          else
            LLVM_URL="${{ env.LLVM_ARM64_URL }}"
            LLVM_FILE="${{ env.LLVM_ARM64_FILE }}"
            ATTESTATION_FILE="${{ env.LLVM_ARM64_ATTESTATION }}"
          fi

          wget --progress=dot:giga "$LLVM_URL"
          gh attestation verify --repo llvm/llvm-project "$LLVM_FILE" --bundle "$ATTESTATION_FILE"
          mkdir -p ~/llvm-21 && tar -xf "$LLVM_FILE" -C ~/llvm-21 --strip-components=1
          rm -f "$LLVM_FILE"

          # ---- Binaryen ----
          if [ "$ARCH" = "x86_64" ]; then
            BURL="${{ env.BINARYEN_X64_URL }}"; BSHA="${{ env.BINARYEN_X64_SHA256 }}"
          else
            BURL="${{ env.BINARYEN_ARM64_URL }}"; BSHA="${{ env.BINARYEN_ARM64_SHA256 }}"
          fi
          wget -O binaryen.tar.gz "$BURL"
          echo "${BSHA}  binaryen.tar.gz" | sha256sum -c -
          mkdir -p ~/binaryen && tar -xzf binaryen.tar.gz -C ~/binaryen --strip-components=1
          rm -f binaryen.tar.gz
          

          # ---- Zopfli ----
          git clone "${{ env.ZOPFLI_REPO }}" zopfli-build
          cd zopfli-build
          git checkout "${{ env.ZOPFLI_COMMIT }}"
          test "$(git rev-parse HEAD)" = "${{ env.ZOPFLI_COMMIT }}"
          make -j
          mkdir -p ~/zopfli/bin && cp zopfli ~/zopfli/bin/
          cd .. && rm -rf zopfli-build
          
          echo "âœ“ All build dependencies installed successfully"
          
          # Quick sanity check that binaries exist
          ls -la ~/llvm-21/bin/clang ~/binaryen/bin/wasm-opt ~/zopfli/bin/zopfli

