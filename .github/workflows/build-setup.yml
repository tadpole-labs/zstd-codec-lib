name: Setup Build Dependencies

on:
  workflow_call:
    outputs:
      cache_key:
        value: ${{ jobs.setup.outputs.cache_key }}

concurrency:
  group: build-setup-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  # LLVM Configuration
  LLVM_VERSION: "21.1.5"
  LLVM_X64_URL: "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.5/LLVM-21.1.5-Linux-X64.tar.xz"
  LLVM_X64_FILE: "LLVM-21.1.5-Linux-X64.tar.xz"
  LLVM_X64_ATTESTATION: ".github/attestations/LLVM-21.1.5-Linux-X64.tar.xz.jsonl"
  LLVM_ARM64_URL: "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.5/LLVM-21.1.5-Linux-ARM64.tar.xz"
  LLVM_ARM64_FILE: "LLVM-21.1.5-Linux-ARM64.tar.xz"
  LLVM_ARM64_ATTESTATION: ".github/attestations/LLVM-21.1.5-Linux-ARM64.tar.xz.jsonl"
  
  # Binaryen Configuration
  BINARYEN_VERSION: "125"
  BINARYEN_X64_URL: "https://github.com/WebAssembly/binaryen/releases/download/version_125/binaryen-version_125-x86_64-linux.tar.gz"
  BINARYEN_X64_SHA256: "7c3bc16599c8274a04d34a504fe4be2047884f900e0e2da2f6fb9cd667183be4"
  BINARYEN_AARCH64_URL: "https://github.com/WebAssembly/binaryen/releases/download/version_125/binaryen-version_125-aarch64-linux.tar.gz"
  BINARYEN_AARCH64_SHA256: "d0382de3c189a7cbb9fdda93e2966f4557f6a00f201e2c4937c27ca01cead4fc"
  
  # Zopfli Configuration
  ZOPFLI_COMMIT: "ccf9f0588d4a4509cb1040310ec122243e670ee6"
  ZOPFLI_REPO: "https://github.com/google/zopfli.git"

jobs:
  setup:
    name: Setup Build Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache_key: ${{ steps.keygen.outputs.key }}
    permissions:
      contents: read
      attestations: read  # required by `gh attestation verify` to fetch attestation
  
    steps:
      - id: keygen
        shell: bash
        env:
          LLVM_VERSION: ${{ env.LLVM_VERSION }}
          BINARYEN_VERSION: ${{ env.BINARYEN_VERSION }}
          ZOPFLI_COMMIT: ${{ env.ZOPFLI_COMMIT }}
          RUNNER_ARCH: ${{ runner.arch }}
          RUNNER_OS: ${{ runner.os }}
        run: |
          echo "key=build-deps-setup-llvm-${LLVM_VERSION}-binaryen-${BINARYEN_VERSION}-zopfli-${ZOPFLI_COMMIT}-${RUNNER_ARCH}-${RUNNER_OS}" >> $GITHUB_OUTPUT

      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        id: cache-deps
        with:
          path: |
            ~/llvm-21
            ~/binaryen
            ~/zopfli
          key: ${{ steps.keygen.outputs.key }}

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
        if: steps.cache-deps.outputs.cache-hit != 'true'
        with:
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false
          persist-awareness: false

      - name: Setup build dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        env:
          LLVM_X64_URL: ${{ env.LLVM_X64_URL }}
          LLVM_X64_FILE: ${{ env.LLVM_X64_FILE }}
          LLVM_X64_ATTESTATION: ${{ env.LLVM_X64_ATTESTATION }}
          LLVM_ARM64_URL: ${{ env.LLVM_ARM64_URL }}
          LLVM_ARM64_FILE: ${{ env.LLVM_ARM64_FILE }}
          LLVM_ARM64_ATTESTATION: ${{ env.LLVM_ARM64_ATTESTATION }}
          BINARYEN_X64_URL: ${{ env.BINARYEN_X64_URL }}
          BINARYEN_X64_SHA256: ${{ env.BINARYEN_X64_SHA256 }}
          BINARYEN_AARCH64_URL: ${{ env.BINARYEN_AARCH64_URL }}
          BINARYEN_AARCH64_SHA256: ${{ env.BINARYEN_AARCH64_SHA256 }}
          ZOPFLI_REPO: ${{ env.ZOPFLI_REPO }}
          ZOPFLI_COMMIT: ${{ env.ZOPFLI_COMMIT }}
        run: |
          set -euo pipefail
          ARCH=$(uname -m)

          # ---- LLVM ----
          if [ "$ARCH" = "x86_64" ]; then
            LLVM_URL="${LLVM_X64_URL}"
            LLVM_FILE="${LLVM_X64_FILE}"
            ATTESTATION_FILE="${LLVM_X64_ATTESTATION}"
          else
            LLVM_URL="${LLVM_ARM64_URL}"
            LLVM_FILE="${LLVM_ARM64_FILE}"
            ATTESTATION_FILE="${LLVM_ARM64_ATTESTATION}"
          fi

          wget --progress=dot:giga "$LLVM_URL"
          gh attestation verify --repo llvm/llvm-project "$LLVM_FILE" --bundle "$ATTESTATION_FILE"
          mkdir -p ~/llvm-21 && tar -xf "$LLVM_FILE" -C ~/llvm-21 --strip-components=1
          rm -f "$LLVM_FILE"

          # ---- Binaryen ----
          if [ "$ARCH" = "x86_64" ]; then
            BURL="${BINARYEN_X64_URL}"; BSHA="${BINARYEN_X64_SHA256}"
          else
            BURL="${BINARYEN_AARCH64_URL}"; BSHA="${BINARYEN_AARCH64_SHA256}"
          fi
          wget -q --show-progress --progress=dot:giga -O binaryen.tar.gz "$BURL"
          echo "${BSHA}  binaryen.tar.gz" | sha256sum -c -
          mkdir -p ~/binaryen && tar -xzf binaryen.tar.gz -C ~/binaryen --strip-components=1
          rm -f binaryen.tar.gz
          

          # ---- Zopfli ----
          git clone "${ZOPFLI_REPO}" zopfli-build
          cd zopfli-build
          git checkout "${ZOPFLI_COMMIT}"
          test "$(git rev-parse HEAD)" = "${ZOPFLI_COMMIT}"
          make -j
          mkdir -p ~/zopfli/bin && cp zopfli ~/zopfli/bin/
          cd .. && rm -rf zopfli-build
          
          echo "âœ“ All build dependencies installed successfully"
          
          # Quick sanity check that binaries exist
          ls -la ~/llvm-21/bin/clang ~/binaryen/bin/wasm-opt ~/zopfli/bin/zopfli
      
      - name: Export tool paths
        run: |
          echo "$HOME/llvm-21/bin" >> $GITHUB_PATH
          echo "$HOME/binaryen/bin" >> $GITHUB_PATH
          echo "$HOME/zopfli/bin" >> $GITHUB_PATH
