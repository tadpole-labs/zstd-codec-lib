var t=4194304,i=t/8;class s{t;i;o;h;u;m;l;S;p;_;A;D;U=!1;v=0;M=0;constructor(t={}){this.m={dictionary:t.dictionary,maxSrcSize:t.maxSrcSize||0,maxDstSize:t.maxDstSize||0}}async init(t){const s=await WebAssembly.instantiate(t,{env:{}});if(this.t=s,this.i=s.exports,this.o=s.exports.memory,this.h=new Uint8Array(this.o.buffer),this.u=new DataView(this.o.buffer),this.m.dictionary){if(this.m.dictionary.length>i/4)throw Error("Dictionary exceeds 2MB maximum size");this.S=this.createDDict(this.m.dictionary)}return this.l=this.i._ZSTD_createDCtx(),this.A=this.W(16),this.D=this.W(16),this.$(!1),this}W(t){if(!this.i)throw Error("WASM module not initialized");return this.i.wasm_malloc(t)}$(s){const r=s?1:2;this.v=i*r,this.M=t/2*r,this._=this.W(this.M),this.p=this.W(this.v),this.U=s}decompressSync(s,r){if(!this.i)throw Error("WASM module not initialized");const e=s.length;if(e>this.m.maxSrcSize)throw Error(`Compressed data (${e} bytes) exceeds maxSrcSize limit (${this.m.maxSrcSize} bytes)`);if(!r||r>t)return this.decompressStream(s,!0).buf;!this.U&&e>i&&this.$(!0),this.h.set(s,this.p);const n=this.i._ZSTD_decompress_usingDDict(this.l,this._,this.M,this.p,e,this.S||0);if(this.B(n))throw Error(`Decompression failed (error code: ${n})`);return this.h.slice(this._,this._+n)}P(t,i,s){this.u.setUint32(t,i,!0),this.u.setUint32(t+4,s,!0),this.u.setUint32(t+8,0,!0)}B(t){if(!this.i)throw Error("WASM module not initialized");return 0!==this.i._ZSTD_isError(t)}decompressStream(t,i=!1){if(!this.i)throw Error("WASM module not initialized");if(i&&(this.i._ZSTD_DCtx_reset(this.l,1),this.S&&this.i._ZSTD_DCtx_refDDict(this.l,this.S)),!t||0===t.length)return{buf:new Uint8Array(0),code:0,input_offset:0};const s=[];let r=0,e=0;for(;r<t.length;){const i=Math.min(t.length-r,131075);for(this.h.set(t.subarray(r,r+i),this.p),this.P(this.A,this.p,i);this.T(this.A+8)<i;){this.P(this.D,this._,131072);const t=this.i._ZSTD_decompressStream(this.l,this.D,this.A);if(this.B(t))throw Error(`Decompression error (error code: ${t})`);const i=this.T(this.D+8);if(i>0){if(e+=i,e>this.m.maxDstSize)throw Error(`Decompressed size (${e} bytes) exceeds maxDstSize limit (${this.m.maxDstSize} bytes)`);s.push(this.h.slice(this._,this._+i))}}r+=i}return{buf:s.length>0?"undefined"!=typeof Buffer?Buffer.concat(s):this.C(s):new Uint8Array(0),code:0,input_offset:t.length}}T(t){return this.u.getUint32(t,!0)}C(t){const i=new Uint8Array(t.reduce((t,i)=>t+i.length,0));let s=0;for(const r of t)i.set(r,s),s+=r.length;return i}freeDCtx(t){if(!this.i)throw Error("WASM module not initialized");return this.i._ZSTD_freeDCtx(t)}createDDict(t){const i=this.W(t.length);return this.h.set(t,i),this.i._ZSTD_createDDict(i,t.length)}freeDDict(t){if(!this.i)throw Error("WASM module not initialized");return this.i._ZSTD_freeDDict(t)}}var r,e=s,n="undefined"!=typeof globalThis&&globalThis.DecompressionStream;class o{readable;writable;constructor(t,i){if("zstd"!==t){if(n){const i=new n(t);return this.readable=i.readable,void(this.writable=i.writable)}throw new TypeError(`Unsupported format: ${t} (native DecompressionStream not available)`)}let s=null,r=!0;const{readable:e,writable:o}=new TransformStream({async start(){s=await i()},async transform(t,e){s||(s=await i());try{const i=s.decompressStream(t,r);r=!1,i.buf.length>0&&e.enqueue(i.buf)}catch(t){e.error(Error("Zstd decompression failed: "+t))}},flush(t){r=!0,t.terminate()}});this.readable=e,this.writable=o}}async function h(t,i){const s=await i(),r=t instanceof ArrayBuffer?new Uint8Array(t):t;return s.decompressStream(r,!0).buf}async function a(t,i,s=!1){const r=await i(),e=t instanceof ArrayBuffer?new Uint8Array(t):t;return r.decompressStream(e,s)}async function c(t,i,s){const r=await i(),e=t instanceof ArrayBuffer?new Uint8Array(t):t;return r.decompressSync(e,s)}var f=!1;async function u(){return r=await WebAssembly.compileStreaming(fetch("./zstd-decoder.wasm")),f=!0,r}async function d(t){const i=f?r:await u(),s=new e({maxSrcSize:33554432,maxDstSize:134217728,dictionary:t?.dictionary});return await s.init(i),s}class m extends o{constructor(t){super(t,d)}}var w=(t,i)=>h(t,()=>d(i)),l=(t,i=!1,s)=>a(t,()=>d(s),i),y=(t,i,s)=>c(t,()=>d(s),i);export{y as decompressSync,l as decompressStream,w as decompress,e as ZstdDecoder,m as DecompressionStream};