function t(t={}){if(!n.loader)throw Error("WASM loader not configured");let r=n.loader(t.wasmPath);return(a=new e({maxSrcSize:o,maxDstSize:c,dictionary:t.dictionary instanceof Uint8Array?t.dictionary:t.dictionary instanceof ArrayBuffer?new Uint8Array(t.dictionary):void 0})).init(r),a}function r(r,i){return t(i),a.decompressStream(r,!0).buf}function i(r,i=!1,s){return t(s),a.decompressStream(r,i)}function s(r,i,s){return t(s),a.decompressSync(r,i)}var e,h,n,a,o,c,f;e=class{t;i;h;o;l;u;m;S=0;_=0;A=0;p=0;U=0;D=0;v=0;P=0;constructor(t={}){this.m={dictionary:t.dictionary,maxSrcSize:t.maxSrcSize||0,maxDstSize:t.maxDstSize||0}}init(t){let r=new WebAssembly.Instance(t,{env:{}});if(this.t=r,this.i=r.exports,this.h=r.exports.memory,this.o=new Uint8Array(this.h.buffer),this.l=new Uint32Array(this.h.buffer),this.u=new DataView(this.h.buffer),this.S=this.i.createDCtx(),this.m.dictionary){if(this.m.dictionary.length>2097152)throw Error("dict>2mb max size");this._=this.W(this.m.dictionary)}return this.U=this.M(24),this.D=this.U+12,this.v=1048576,this.P=8388608,this.A=this.M(this.v),this.p=this.A+this.v,this}M(t){return this.i.bmalloc(t)}decompressSync(t,r){if(!this.i)throw Error("module not initialized");let i=t.length;if(i>this.m.maxSrcSize)throw Error(`comp data ${i}b>maxSrcSize lim ${this.m.maxSrcSize}b)`);if(!r||r>8388608)return this.decompressStream(t,!0).buf;this.o.set(t,this.A);let s=this.i._decompressSync(this.S,this.p,this.P,this.A,i,this._||0);if(this.T(s))throw Error("decomp failed err "+s);return this.o.slice(this.p,this.p+s)}T(t){return 0!==this.i.isError(t)}$(t,r,i,s=0){let e=t>>>2;this.l[e]=r,this.l[e+1]=i,this.l[e+2]=s}B(t){return this.l[t+8>>>2]}decompressStream(t,r=!1){if(!this.i)throw Error("WASM module not initialized");if(r&&(this.i.reset(this.S),this._&&this.i.refDict(this.S,this._),this.i.prune_buf(this.p)),!t||0===t.length)return{buf:new Uint8Array(0),code:0,in_offset:0};let i=[],s=0,e=0,h=131075,n=this.A+h;for(;t.length>e;){let r=Math.min(t.length-e,131075);for(this.o.set(t.subarray(e,e+r),this.A),this.$(this.U,this.A,r,0);this.B(this.U)<r;){this.$(this.D,n,131072,0);let t=this.i.decStream(this.S,this.D,this.U);if(this.T(t))throw Error("decomp err "+t);let r=this.B(this.D);if(r>0){if(s+=r,s>this.m.maxDstSize)throw Error(`decomp size ${s}b>maxDstSize lim ${this.m.maxDstSize}b`);i.push(this.o.slice(n,n+r))}t>0&&131075>t&&(h=t)}e+=r}return{buf:this.H(i),code:0,in_offset:t.length}}H(t){let r=new Uint8Array(t.reduce((t,r)=>t+r.length,0)),i=0;for(let s of t)r.set(s,i),i+=s.length;return r}W(t){let r=this.M(t.length);return this.o.set(t,r),this.i.createDict(r,t.length)}},h="u">typeof globalThis&&globalThis.DecompressionStream;class l{readable;writable;constructor(t,r){if("zstd"!==t){if(h){let r=new h(t);return this.readable=r.readable,void(this.writable=r.writable)}throw TypeError(t+" not available")}let i=null,s=!0,{readable:e,writable:n}=new TransformStream({async start(){i=await r()},async transform(t,e){i||(i=await r());try{let r=i.decompressStream(t,s);s=!1,r.buf.length>0&&e.enqueue(r.buf)}catch(t){e.error(Error("decomp err "+t))}},flush(t){t.terminate()}});this.readable=e,this.writable=n}}n={loader:null},o=67108864,c=134217728;class u extends l{constructor(t,r){super(t,async()=>{if(!n.loader)throw Error("WASM loader not configured");let t=n.loader(r?.wasmPath),i=r?.dictionary?await(async t=>{if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);let r=await fetch(t);return new Uint8Array(await r.arrayBuffer())})(r.dictionary):void 0,s=new e({maxSrcSize:o,maxDstSize:c,dictionary:i});return s.init(t),s})}}f=null,WebAssembly.compileStreaming(fetch("./zstd-decoder.wasm")).then(t=>f=t),n.loader=()=>{if(!f)throw Error("WASM not ready");return f};export{s as decompressSync,i as decompressStream,r as decompress,t as createDecoder,e as ZstdDecoder,u as DecompressionStream};