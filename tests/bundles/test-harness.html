<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WASM Test Harness</title>
</head>
<body>
  <script type="module">
    import { ZstdDecoder } from 'http://localhost:42069/packages/zstd-wasm-decoder/src/_esm/zstd-wasm.js';
    
    async function loadDictionary(name) {
      try {
        const response = await fetch(`http://localhost:42069/dictionaries/${name}`);
        if (!response.ok) return null;
        return new Uint8Array(await response.arrayBuffer());
      } catch {
        return null;
      }
    }
    
    // Load and compile WASM module once (reuse for all decoders)
    const wasmUrl = 'http://localhost:42069/packages/zstd-wasm-decoder/src/_esm/zstd-decoder.wasm';
    const wasmModule = await WebAssembly.compileStreaming(fetch(wasmUrl));
    
    // Load all dictionaries
    const dictionaries = {
      test: await loadDictionary('test.dict'),
      json: await loadDictionary('test.json.dict'),
      http: await loadDictionary('../edge-cases/golden-dictionaries/http-dict-missing-symbols'),
      zeroWeight: await loadDictionary('../edge-cases/dict-files/zero-weight-dict'),
    };

    // Pre-compute dictionary hashes for fast lookup
    const dictHashes = new Map();
    for (const [name, dict] of Object.entries(dictionaries)) {
      if (dict) {
        const hash = await crypto.subtle.digest('SHA-256', dict);
        dictHashes.set(bufferToHex(hash), name);
      }
    }

    const decoders = new Map();
    
    // No-dict decoder
    const mainDecoder = new ZstdDecoder({
      maxSrcSize: 100 * 1024 * 1024,
      maxDstSize: 100 * 1024 * 1024
    });
    await mainDecoder.init(wasmModule);
    decoders.set('', mainDecoder);
    
    // Dict decoders
    for (const [name, dict] of Object.entries(dictionaries)) {
      if (dict) {
        const decoder = new ZstdDecoder({
          maxSrcSize: 100 * 1024 * 1024,
          maxDstSize: 100 * 1024 * 1024,
          dictionary: dict
        });
        await decoder.init(wasmModule);
        decoders.set(name, decoder);
      }
    }
    
    // Expose API
    window.ZstdWasm = {
      ready: true,
      
      decompressSync: async (data, opts = {}) => {
        const dictName = opts.dictionary ? await getDictName(opts.dictionary) : '';
        const decoder = decoders.get(dictName) || mainDecoder;
        return decoder.decompressSync(data);
      },
      
      decompressStream: async (data, isFirst = false, opts = {}) => {
        const dictName = opts.dictionary ? await getDictName(opts.dictionary) : '';
        const decoder = decoders.get(dictName) || mainDecoder;
        return decoder.decompressStream(data, isFirst);
      },
      
      decompress: (data, opts) => window.ZstdWasm.decompressSync(data, opts),
    };
    
    async function getDictName(dictData) {
      const hash = await crypto.subtle.digest('SHA-256', dictData);
      return dictHashes.get(bufferToHex(hash)) || '';
    }
    
    function bufferToHex(buffer) {
      return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }
    
    console.log('WASM decoder initialized with dictionaries:', Object.keys(dictionaries).filter(k => dictionaries[k]));
  </script>
</body>
</html>

