import{readFileSync as t}from"fs";import{join as i}from"path";import*as e from"node:zlib";import{readFileSync as s}from"fs";function r(t={}){if(!a.loader)throw Error("WASM loader not configured");let i=a.loader(t.wasmPath);return(m=new h({maxSrcSize:c,maxDstSize:f,dictionary:t.dictionary instanceof Uint8Array?t.dictionary:t.dictionary instanceof ArrayBuffer?new Uint8Array(t.dictionary):void 0})).init(i),l=!0,m}function o(t,i){return l||r(i),m.decompressStream(t,!0).buf}function n(t,i=!1,e){return l||r(e),m.decompressStream(t,i)}var h,a,m,l,c,f,d,p;h=class{t;i;h;o;l;u;m;S=0;_=0;p=0;A=0;U=0;D=0;v=0;P=0;constructor(t={}){this.m={dictionary:t.dictionary,maxSrcSize:t.maxSrcSize||0,maxDstSize:t.maxDstSize||0}}init(t){let i=new WebAssembly.Instance(t,{env:{}});if(this.t=i,this.i=i.exports,this.h=i.exports.memory,this.o=new Uint8Array(this.h.buffer),this.l=new Uint32Array(this.h.buffer),this.u=new DataView(this.h.buffer),this.S=this.i.createDCtx(),this.m.dictionary){if(this.m.dictionary.length>2097152)throw Error("dict>2mb max size");this._=this.W(this.m.dictionary)}return this.U=this.M(24),this.D=this.U+12,this.v=1048576,this.P=8388608,this.p=this.M(this.v),this.A=this.p+this.v,this}M(t){return this.i.bmalloc(t)}decompressSync(t,i){if(!this.i)throw Error("module not initialized");let e=t.length;if(e>this.m.maxSrcSize)throw Error(`comp data ${e}b>maxSrcSize lim ${this.m.maxSrcSize}b)`);if(!i||i>8388608)return this.decompressStream(t,!0).buf;this.o.set(t,this.p);let s=this.i._decompressSync(this.S,this.A,this.P,this.p,e,this._||0);if(this.T(s))throw Error("decomp failed err "+s);return this.o.slice(this.A,this.A+s)}T(t){return 0!==this.i.isError(t)}$(t,i,e,s=0){let r=t>>>2;this.l[r]=i,this.l[r+1]=e,this.l[r+2]=s}B(t){return this.l[t+8>>>2]}decompressStream(t,i=!1){if(!this.i)throw Error("WASM module not initialized");if(i&&(this.i.reset(this.S),this._&&this.i.refDict(this.S,this._),this.i.prune_buf(this.A)),!t||0===t.length)return{buf:new Uint8Array(0),code:0,in_offset:0};let e=[],s=0,r=0,o=131075,n=this.p+o;for(;t.length>r;){let i=Math.min(t.length-r,131075);for(this.o.set(t.subarray(r,r+i),this.p),this.$(this.U,this.p,i,0);this.B(this.U)<i;){this.$(this.D,n,131072,0);let t=this.i.decStream(this.S,this.D,this.U);if(this.T(t))throw Error("decomp err "+t);let i=this.B(this.D);if(i>0){if(s+=i,s>this.m.maxDstSize)throw Error(`decomp size ${s}b>maxDstSize lim ${this.m.maxDstSize}b`);e.push(this.o.slice(n,n+i))}t>0&&131075>t&&(o=t)}r+=i}return{buf:this.H(e),code:0,in_offset:t.length}}H(t){let i=new Uint8Array(t.reduce((t,i)=>t+i.length,0)),e=0;for(let s of t)i.set(s,e),e+=s.length;return i}W(t){let i=this.M(t.length);return this.o.set(t,i),this.i.createDict(i,t.length)}},"u">typeof globalThis&&globalThis.DecompressionStream,a={loader:null},l=!1,c=67108864,f=134217728,d=new URL("./zstd-decoder.wasm",import.meta.url),p=new WebAssembly.Module(s(d)),a.loader=()=>p;import{readFileSync as u,readdirSync as S}from"fs";import{join as y}from"path";import*as w from"node:zlib";var z=t=>S(t).filter(t=>t.endsWith(".zst")).map(i=>u(y(t,i))),b="undefined"!=typeof Bun,D=b?"Bun":"Node.js",g=async(t,i,e,s)=>{let r=0,o=0;for(let t=0;t<e.length;t++){const n=performance.now();await i(e[t]),o+=performance.now()-n,r+=s[t]/1024/1024}return{name:t,mbps:r/(o/1e3)}},x=i(import.meta.dirname||__dirname,"compressed"),A=JSON.parse(t(i(x,"metadata.json"),"utf-8")),U=z(x).filter((t,i,e)=>!(e.length>A.fileCount)||i<A.fileCount),B=z(x).filter((t,i,e)=>e.length>A.fileCount?i>=A.fileCount:[]);await(async t=>{for(let i=0;i<3;i++)for(const i of t)e.zstdDecompressSync(i),b&&Bun.zstdDecompressSync(i),await o(i),await n(i,!0)})(B);var v=[];v.push(await g("node:zlib (sync)",t=>e.zstdDecompressSync(t),U,A.fileSizes)),v.push(await g("node:zlib (async)",t=>new Promise((i,s)=>e.zstdDecompress(t,(t,e)=>t?s(t):i(e))),U,A.fileSizes)),b&&(v.push(await g("Bun native (sync)",t=>Bun.zstdDecompressSync(t),U,A.fileSizes)),v.push(await g("Bun native (async)",t=>Bun.zstdDecompress(t),U,A.fileSizes))),v.push(await g("zstd-wasm (decompress)",t=>o(t),U,A.fileSizes)),v.push(await g("zstd-wasm (decompressStream)",t=>n(t,!0),U,A.fileSizes)),console.log(""+"=".repeat(50)),console.log("Runtime: "+D),console.log(""+"=".repeat(50));for(const{name:t,mbps:i}of v)console.log(`${t.padEnd(30)} ${i.toFixed(2).padStart(10)} MB/s`);console.log(""+"=".repeat(50));